---
date: 2020-09-19T21:06:02+08:00  # 创建日期
author: "Rustle Karl"  # 作者

# 文章
title: "Message Queue 简介"  # 文章标题
description: "纸上得来终觉浅，学到过知识点分分钟忘得一干二净，今后无论学什么，都做好笔记吧。"
url:  "posts/go/web/mq/intro"  # 设置网页永久链接
tags: [ "go", "mq", "intro" ]  # 标签
series: [ "Go 学习笔记"]  # 系列
categories: [ "学习笔记"]  # 分类

# 章节
weight: 20 # 排序优先级
chapter: false  # 设置为章节

index: true  # 是否可以被索引
toc: true  # 是否自动生成目录
draft: false  # 草稿
---

## 什么是消息队列

消息队列（Message Queue，简称MQ），指保存消息的一个容器，本质是个队列。

消息（Message）是指在应用之间传送的数据，消息可以非常简单，比如只包含文本字符串，也可以更复杂，可能包含嵌入对象。

消息队列（Message Queue）是一种应用间的通信方式，消息发送后可以立即返回，有消息系统来确保信息的可靠专递，消息发布者只管把消息发布到 MQ 中而不管谁来取，消息使用者只管从 MQ 中取消息而不管谁发布的，这样发布者和使用者都不用知道对方的存在。

![](imgs/mq.jpg)

- Producer：消息生产者，负责产生和发送消息到 Broker；
- Broker：消息处理中心。负责消息存储、确认、重试等，一般其中会包含多个 queue；
- Consumer：消息消费者，负责从 Broker 中获取消息，并进行相应处理。

现在常用的 MQ 组件有 ActiveMQ、RabbitMQ、RocketMQ、ZeroMQ。近年来火热的 Kafka，从某些场景来说也是 MQ，当然 Kafka 的功能更加强大。

## 为什么需要消息队列

在高并发分布式环境下，由于来不及同步处理，通过使用消息队列，可以异步处理请求，从而缓解系统的压力。

举一个订单系统的例子：用户点击下订单，会触发以下业务逻辑流程：

- 扣减库存
- 生成相应的订单
- 发短信通知等等

在业务发展初期这些逻辑可能放在一起同步执行，随着业务订单量增长，需要提升系统服务的性能，这时候可以将一些不需要立即生效的操作拆分出来异步执行，比如发短信通知等，这种场景就可以使用消息队列 MQ。

本质还是通过异步来解决同步的系统压力，所以我们在做架构设计的时候有一个原则：能异步的就尽量不要同步。

## 消息队列的优点

1. **屏蔽异构平台的细节**：发送方、接收方系统之间不需要了解双方，只需认识消息。
2. **异步**：消息堆积能力；发送方接收方不需同时在线，发送方接收方不需同时扩容（削峰）。
3. **解耦**：防止引入过多的API给系统的稳定性带来风险；调用方使用不当会给被调用方系统造成压力，被调用方处理不当会降低调用方系统的响应能力。
4. **复用**：一次发送多次消费。
5. **可靠**：一次保证消息的传递。如果发送消息时接收者不可用，消息队列会保留消息，直到成功地传递它。
6. **提供路由**：发送者无需与接收者建立连接，双方通过消息队列保证消息能够从发送者路由到接收者，甚至对于本来网络不易互通的两个服务，也可以提供消息路由。

## 消息队列的特点

**异步性**

将耗时的同步操作，通过以发送消息的方式，进行了异步化处理。减少了同步等待的时间。

**松耦合**

消息队列减少了服务之间的耦合性，不同的服务可以通过消息队列进行通信，而不用关心彼此的实现细节，只要定义好消息的格式就行。

**分布式**

通过对消费者的横向扩展，降低了消息队列阻塞的风险，以及单个消费者产生单点故障的可能性（*当然消息队列本身也可以做成分布式集群*）。

**可靠性**

消息队列一般会把接收到的消息存储到本地硬盘上（*当消息被处理完之后，存储信息根据不同的消息队列实现，有可能将其删除*），这样即使应用挂掉或者消息队列本身挂掉，消息也能够重新加载。

## 消息队列的选型

1. ActiveMQ

Apache 出品

2. RabbitMQ

RabbitMQ 是 erlang 语言开发，结合 erlang 语言本身的并发优势，支持很多的协议：AMQP，XMPP, SMTP, STOMP，也正是如此，使的它变的非常重量级，更适合于企业级的开发。性能较好，但是不利于做二次开发和维护。

3. RocketMQ

阿里开源的消息中间件，纯 Java 开发，具有高吞吐量、高可用性、适合大规模分布式系统应用的特点。

4. ZeroMQ

号称最快的消息队列系统，尤其针对大吞吐量的需求场景。扩展性好，开发比较灵活，采用 C 语言实现，实际上只是一个 socket 库的重新封装，如果做为消息队列使用，需要开发大量的代码。

5. Kafka

Kafka 是 Apache 下的一个子项目，是一个高性能跨语言分布式发布/订阅消息队列系统，而 Jafka 是在 Kafka 之上孵化而来的，即 Kafka 的一个升级版。
